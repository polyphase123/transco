<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransCo Vehicle Dispatch and Monitoring</title>
    
    <!-- Leaflet.js for Interactive Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #00796B; /* Teal */
            --primary-dark: #004D40;
            --background-main: #f0f4f8;
            --background-panel: #ffffff;
            --border-color: #CFD8DC;
            --text-dark: #263238;
            --text-light: #546E7A;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            --button-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            
            /* Status Colors */
            --status-available: #4CAF50; /* Green */
            --status-on-trip: #2196F3;   /* Blue */
            --status-maintenance: #FFC107; /* Amber */
            --status-out-of-service: #F44336; /* Red */
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--background-main);
            color: var(--text-dark);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .container { display: flex; width: 100%; height: 100%; }
        .control-panel { width: 40%; max-width: 650px; padding: 24px; background-color: var(--background-panel); overflow-y: auto; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .map-container { flex-grow: 1; height: 100%; position: relative; }
        #map { width: 100%; height: 100%; background-color: #eef2f5; }
        
        .panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
        .panel-header-title { display: flex; align-items: center; }
        .panel-header img { width: 50px; height: 50px; margin-right: 16px; border-radius: 50%; }
        .panel-header h1 { font-size: 24px; font-weight: 700; color: var(--primary-dark); margin: 0; }
        
        .app-controls { display: flex; gap: 12px; align-items: center; }
        .app-controls select { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border-color); }
        
        .dashboard { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background-color: #f8f9fa; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; text-align: center; }
        .stat-card .value { font-size: 24px; font-weight: 700; }
        .stat-card .label { font-size: 12px; color: var(--text-light); }
        
        .filters { display: flex; gap: 16px; margin-bottom: 20px; }
        .search-box { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; }
        
        .section { margin-bottom: 24px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-header h2 { font-size: 20px; color: var(--text-dark); margin: 0; font-weight: 600; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease-in-out; box-shadow: var(--button-shadow); }
        .btn:disabled { background-color: #BDBDBD; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-danger { background-color: #d32f2f; color: white; }
        .btn-danger:hover { background-color: #b71c1c; }
        .btn-secondary { background-color: #607D8B; color: white; }
        .btn-secondary:hover { background-color: #455A64; }
        
        .vehicle-card { background-color: #fff; border: 1px solid var(--border-color); border-left: 5px solid; border-radius: 8px; margin-bottom: 16px; box-shadow: var(--card-shadow); transition: border-color 0.3s; }
        .vehicle-card[data-status="Available"] { border-left-color: var(--status-available); }
        .vehicle-card[data-status="On Trip"] { border-left-color: var(--status-on-trip); }
        .vehicle-card[data-status="Maintenance"] { border-left-color: var(--status-maintenance); }
        .vehicle-card[data-status="Out of Service"] { border-left-color: var(--status-out-of-service); }
        
        .vehicle-card details > summary { padding: 16px; cursor: pointer; list-style: none; }
        .vehicle-card details > summary::-webkit-details-marker { display: none; }
        .vehicle-card-header { display: flex; justify-content: space-between; align-items: center; }
        .vehicle-card-header h3 { margin: 0; font-size: 16px; font-weight: 600; }
        .vehicle-card-body { padding: 0 16px 16px; border-top: 1px solid var(--border-color); }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-size: 12px; font-weight: 500; color: var(--text-light); margin-bottom: 4px; }
        .form-group input, .form-group select, .form-group textarea { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; }
        
        .driver-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background-color: #f8fafc; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background-color: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; }
        .modal-content h2 { margin-top: 0; }
        
        /* History & Analytics Styles */
        .history-item { border-bottom: 1px solid var(--border-color); padding: 10px 0; }
        .history-item:last-child { border-bottom: none; }
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        
        /* User Role Permissions */
        [data-role="Dispatcher"] .admin-only { display: none !important; }

        .app-footer { font-size: 12px; color: var(--text-light); text-align: center; padding: 8px 0; border-top: 1px solid var(--border-color); margin-top: auto; }
        .toast { position: absolute; top: 20px; right: 20px; background-color: rgba(0,0,0,0.75); color: white; padding: 12px 20px; border-radius: 8px; z-index: 1001; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        .toast.show { opacity: 1; }

        .vehicle-marker { color: white; border: 2px solid white; border-radius: 8px; padding: 4px 8px; font-size: 12px; font-weight: bold; text-align: center; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: background-color 0.3s; }
        .marker-status-Available { background-color: var(--status-available); }
        .marker-status-On-Trip { background-color: var(--status-on-trip); }
        .marker-status-Maintenance { background-color: var(--status-maintenance); }
        .marker-status-Out-of-Service { background-color: var(--status-out-of-service); }
    </style>
</head>
<body>
    <div class="container">
        <!-- LEFT COLUMN: CONTROL PANEL -->
        <div class="control-panel" id="control-panel">
            <header class="panel-header">
                <div class="panel-header-title">
                    <img src="https://placehold.co/100x100/00796B/FFFFFF?text=TC" alt="TransCo Logo">
                    <h1>Dispatch Control</h1>
                </div>
                <div class="app-controls">
                    <button class="btn btn-secondary" data-action="show-analytics">Analytics</button>
                    <select id="user-role-selector">
                        <option value="Administrator">Administrator</option>
                        <option value="Dispatcher">Dispatcher</option>
                    </select>
                </div>
            </header>

            <div class="section dashboard" id="dashboard-stats"></div>
            
            <div class="section" id="fleet-management">
                <div class="section-header">
                    <h2>Fleet Management</h2>
                    <button class="btn btn-primary admin-only" data-action="add-vehicle">Add New Vehicle</button>
                </div>
                <div id="vehicle-list"></div>
            </div>

            <div class="section" id="driver-management">
                <div class="section-header">
                    <h2>Driver Management</h2>
                    <button class="btn btn-primary admin-only" data-action="add-driver">Add New Driver</button>
                </div>
                <div id="driver-list"></div>
            </div>

            <div class="app-footer" id="app-footer"></div>
        </div>

        <!-- RIGHT COLUMN: MAP -->
        <div class="map-container">
            <div id="map"></div>
            <div id="toast-message" class="toast"></div>
        </div>
    </div>

    <!-- MODAL CONTAINER -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content" id="modal-content">
            <button class="modal-close" data-action="close-modal">&times;</button>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                state: {
                    vehicles: [],
                    drivers: [],
                    currentUserRole: 'Administrator',
                },
                map: null,
                markers: {},
                charts: {},
                transCoHQ: [14.6470, 121.0485],
                
                ui: {
                    controlPanel: document.getElementById('control-panel'),
                    dashboard: document.getElementById('dashboard-stats'),
                    vehicleList: document.getElementById('vehicle-list'),
                    driverList: document.getElementById('driver-list'),
                    footer: document.getElementById('app-footer'),
                    toast: document.getElementById('toast-message'),
                    modalOverlay: document.getElementById('modal-overlay'),
                    modalBody: document.getElementById('modal-body'),
                    roleSelector: document.getElementById('user-role-selector'),
                },

                // --- INITIALIZATION ---
                init() {
                    this.loadState();
                    this.initMap();
                    this.render();
                    this.initEventListeners();
                    this.updateRoleUI();
                    this.ui.footer.textContent = `Pasig City, Metro Manila | Last Load: ${new Date().toLocaleString()}`;
                    this.state.vehicles.forEach(v => {
                        if (v.status === 'On Trip' && v.jobOrder.destination) this.mapHandlers.setDestinationOnMap.call(this, v.id, false);
                    });
                },

                initMap() {
                    this.map = L.map('map').setView(this.transCoHQ, 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(this.map);
                    L.marker(this.transCoHQ, { title: "TransCo Headquarters" }).addTo(this.map).bindPopup("<b>TransCo HQ</b>").openPopup();
                },

                initEventListeners() {
                    this.ui.controlPanel.addEventListener('click', this.eventHandlers.handlePanelClick.bind(this));
                    this.ui.controlPanel.addEventListener('change', this.eventHandlers.handlePanelChange.bind(this));
                    this.ui.modalOverlay.addEventListener('click', e => {
                        if (e.target === this.ui.modalOverlay || e.target.closest('[data-action="close-modal"]')) {
                            this.ui.modalOverlay.classList.remove('show');
                        }
                    });
                    this.ui.roleSelector.addEventListener('change', e => {
                        this.state.currentUserRole = e.target.value;
                        this.updateRoleUI();
                        this.saveState();
                    });
                },
                
                // --- STATE & DATA MANAGEMENT ---
                getDefaultState() {
                    return {
                        vehicles: [
                            { id: 1, plate: 'ABC-1234', model: 'Toyota Hilux', odometer: 54321, driverId: 1, status: 'Available', nextServiceKm: 60000, jobOrder: { ticket: '', destination: '', task: '', priority: 'Medium' }, history: [] },
                            { id: 2, plate: 'DEF-5678', model: 'Mitsubishi Montero Sport', odometer: 12345, driverId: 2, status: 'On Trip', nextServiceKm: 20000, jobOrder: { ticket: 'T-001', destination: 'Batangas Port', task: 'Inspect Substation', priority: 'High' }, history: [{ticket: 'T-000', destination: 'Quezon City', task: 'Routine Check', driverName: 'Goku', completedDate: '2023-10-25T10:00:00.000Z'}] },
                            { id: 3, plate: 'GHI-9012', model: 'Ford Ranger', odometer: 89012, driverId: 3, status: 'Maintenance', nextServiceKm: 90000, jobOrder: { ticket: '', destination: '', task: '', priority: 'Medium' }, history: [] },
                            { id: 4, plate: 'JKL-3456', model: 'Toyota Innova', odometer: 34567, driverId: 4, status: 'Available', nextServiceKm: 40000, jobOrder: { ticket: '', destination: '', task: '', priority: 'Medium' }, history: [] },
                            { id: 5, plate: 'MNO-7890', model: 'Nissan Navara', odometer: 78901, driverId: 5, status: 'On Trip', nextServiceKm: 85000, jobOrder: { ticket: 'T-002', destination: 'Clark, Pampanga', task: 'Deliver equipment', priority: 'Medium' }, history: [] },
                            { id: 6, plate: 'PQR-1122', model: 'Toyota Fortuner', odometer: 11223, driverId: null, status: 'Available', nextServiceKm: 15000, jobOrder: { ticket: '', destination: '', task: '', priority: 'Medium' }, history: [] },
                            { id: 7, plate: 'STU-3344', model: 'Isuzu D-Max', odometer: 33445, driverId: 7, status: 'Out of Service', nextServiceKm: 40000, jobOrder: { ticket: '', destination: '', task: '', priority: 'Medium' }, history: [] },
                            { id: 8, plate: 'VWX-5566', model: 'Toyota Vios', odometer: 55667, driverId: 8, status: 'Available', nextServiceKm: 60000, jobOrder: { ticket: '', destination: '', task: '', priority: 'Medium' }, history: [] },
                            { id: 9, plate: 'YZA-7788', model: 'Mitsubishi L300', odometer: 77889, driverId: 9, status: 'Maintenance', nextServiceKm: 75000, jobOrder: { ticket: '', destination: '', task: '', priority: 'Medium' }, history: [] },
                            { id: 10, plate: 'BCD-9900', model: 'Hyundai H100', odometer: 99001, driverId: 10, status: 'On Trip', nextServiceKm: 105000, jobOrder: { ticket: 'T-003', destination: 'Subic Bay', task: 'Personnel Transport', priority: 'Low' }, history: [] }
                        ],
                        drivers: [ 
                            { id: 1, name: 'Goku' }, { id: 2, name: 'Vegeta' }, { id: 3, name: 'Piccolo' }, { id: 4, name: 'Gohan' }, { id: 5, name: 'Trunks' },
                            { id: 6, name: 'Krillin' }, { id: 7, name: 'Master Roshi' }, { id: 8, name: 'Android 18' }, { id: 9, name: 'Bulma' }, { id: 10, name: 'Chi-Chi' }
                        ],
                        currentUserRole: 'Administrator',
                    };
                },

                saveState() {
                    localStorage.setItem('transcoDispatchState', JSON.stringify(this.state));
                },

                loadState() {
                    const savedState = localStorage.getItem('transcoDispatchState');
                    this.state = savedState ? JSON.parse(savedState) : this.getDefaultState();
                },

                get(type, id) { return this.state[type].find(item => item.id === id); },
                
                add(type, data) {
                    const collection = this.state[type];
                    const newId = collection.length > 0 ? Math.max(...collection.map(i => i.id)) + 1 : 1;
                    const newItemDefaults = type === 'vehicles' ? { history: [] } : {};
                    const newItem = { id: newId, ...newItemDefaults, ...data };
                    collection.push(newItem);
                    this.render(); this.saveState();
                },

                remove(type, id) {
                    this.state[type] = this.state[type].filter(item => item.id !== id);
                    if (type === 'vehicles') {
                        this.mapHandlers.removeMapElements.call(this, id);
                    } else if (type === 'drivers') {
                        this.state.vehicles.forEach(v => { if (v.driverId === id) v.driverId = null; });
                    }
                    this.render(); 
                    this.saveState(); 
                },

                update(type, id, field, value) {
                    const item = this.get(type, id);
                    if (!item) return;

                    const oldValue = item[field]; // For history tracking
                    
                    if (['odometer', 'nextServiceKm', 'driverId'].includes(field)) {
                        item[field] = value === '' ? null : parseInt(value);
                    } else { item[field] = value; }

                    if (type === 'vehicles' && field === 'status' && oldValue === 'On Trip' && value === 'Available') {
                        this.archiveJobOrder(id);
                    }
                    
                    this.render(); this.saveState();
                },

                updateJobOrder(vehicleId, field, value) { 
                    const vehicle = this.get('vehicles', vehicleId);
                    if (vehicle) vehicle.jobOrder[field] = value;
                    this.saveState(); 
                },
                
                archiveJobOrder(vehicleId) {
                    const vehicle = this.get('vehicles', vehicleId);
                    if (!vehicle || !vehicle.jobOrder.ticket) return;

                    const driver = this.get('drivers', vehicle.driverId);
                    const historyEntry = {
                        ...vehicle.jobOrder,
                        driverName: driver ? driver.name : 'N/A',
                        completedDate: new Date().toISOString(),
                    };
                    vehicle.history.unshift(historyEntry); // Add to beginning of array
                    // Reset job order
                    vehicle.jobOrder = { ticket: '', destination: '', task: '', priority: 'Medium' };
                    this.view.showToast(`Trip ${historyEntry.ticket} completed and archived.`);
                },

                render() {
                    this.view.renderAll.call(this);
                },

                updateRoleUI() {
                    this.ui.controlPanel.dataset.role = this.state.currentUserRole;
                    this.ui.roleSelector.value = this.state.currentUserRole;
                },
                
                // --- VIEW / UI LOGIC ---
                view: {
                    renderAll() {
                        this.view.renderDashboard.call(this);
                        this.view.renderVehicles.call(this);
                        this.view.renderDrivers.call(this);
                    },
                    renderDashboard() {
                        const stats = {
                            onTrip: this.state.vehicles.filter(v => v.status === 'On Trip').length,
                            available: this.state.vehicles.filter(v => v.status === 'Available').length,
                            maintenanceReq: this.state.vehicles.filter(v => v.status === 'Maintenance' || (v.odometer && v.nextServiceKm && v.odometer >= v.nextServiceKm)).length,
                            outOfService: this.state.vehicles.filter(v => v.status === 'Out of Service').length,
                        };
                        this.ui.dashboard.innerHTML = `
                            <div class="stat-card"><div class="value">${stats.onTrip}</div><div class="label">On Trip</div></div>
                            <div class="stat-card"><div class="value">${stats.available}</div><div class="label">Available</div></div>
                            <div class="stat-card"><div class="value">${stats.maintenanceReq}</div><div class="label">Needs Service</div></div>
                            <div class="stat-card"><div class="value">${stats.outOfService}</div><div class="label">Out of Service</div></div>
                        `;
                    },
                    renderVehicles() { this.ui.vehicleList.innerHTML = this.state.vehicles.map(v => this.view.getVehicleHTML.call(this, v)).join(''); },
                    renderDrivers() { this.ui.driverList.innerHTML = this.state.drivers.map(d => this.view.getDriverHTML.call(this, d)).join(''); },
                    
                    getDriverOptions(selectedDriverId) {
                        return [
                            '<option value="">-- Unassigned --</option>',
                            ...this.state.drivers.map(driver => `<option value="${driver.id}" ${driver.id == selectedDriverId ? 'selected' : ''}>${driver.name}</option>`)
                        ].join('');
                    },

                    getDriverHTML(driver) {
                        return `<div class="driver-list-item" data-id="${driver.id}"><span>${driver.name}</span><button class="btn btn-danger btn-sm admin-only" data-action="remove-driver" data-id="${driver.id}">Remove</button></div>`;
                    },

                    getVehicleHTML(vehicle) {
                        const statusOptions = ['Available', 'On Trip', 'Maintenance', 'Out of Service'].map(s => `<option value="${s}" ${s === vehicle.status ? 'selected' : ''}>${s}</option>`).join('');
                        const priorityOptions = ['Low', 'Medium', 'High'].map(p => `<option value="${p}" ${p === vehicle.jobOrder.priority ? 'selected' : ''}>${p}</option>`).join('');
                        const needsService = vehicle.odometer >= vehicle.nextServiceKm;
                        
                        return `
                            <div class="vehicle-card" data-id="${vehicle.id}" data-status="${vehicle.status}">
                                <details>
                                    <summary><div class="vehicle-card-header"><h3>${vehicle.plate} - ${vehicle.model}</h3>${needsService ? '<span style="color:red;font-weight:bold;font-size:1.2em;margin-left:8px;">!</span>' : ''}</div></summary>
                                    <div class="vehicle-card-body">
                                        <div style="display:flex; justify-content: flex-end; gap: 8px; margin-bottom: 10px;">
                                            <button class="btn btn-secondary" data-action="view-history" data-id="${vehicle.id}">History</button>
                                            <button class="btn btn-danger admin-only" data-action="remove-vehicle" data-id="${vehicle.id}">Remove</button>
                                        </div>
                                        <div class="form-grid">
                                            <div class="form-group"><label>Plate Number</label><input type="text" value="${vehicle.plate}" data-field="plate" data-id="${vehicle.id}"></div>
                                            <div class="form-group"><label>Vehicle Model</label><input type="text" value="${vehicle.model}" data-field="model" data-id="${vehicle.id}"></div>
                                            <div class="form-group"><label>Odometer (km)</label><input type="number" value="${vehicle.odometer || ''}" data-field="odometer" data-id="${vehicle.id}"></div>
                                            <div class="form-group"><label>Next Service (km)</label><input type="number" value="${vehicle.nextServiceKm || ''}" data-field="nextServiceKm" data-id="${vehicle.id}"></div>
                                            <div class="form-group"><label>Assigned Driver</label><select data-field="driverId" data-id="${vehicle.id}">${this.view.getDriverOptions.call(this, vehicle.driverId)}</select></div>
                                            <div class="form-group"><label>Status</label><select data-field="status" data-id="${vehicle.id}">${statusOptions}</select></div>
                                            <hr style="grid-column: 1 / -1; border: 0; border-top: 1px solid var(--border-color); margin: 10px 0;"><h4 style="grid-column: 1 / -1; margin: 0 0 10px 0;">Job Order</h4>
                                            <div class="form-group"><label>Ticket #</label><input type="text" value="${vehicle.jobOrder.ticket || ''}" data-job-field="ticket" data-id="${vehicle.id}"></div>
                                            <div class="form-group"><label>Priority</label><select data-job-field="priority" data-id="${vehicle.id}">${priorityOptions}</select></div>
                                            <div class="form-group full-width"><label>Task Description</label><textarea rows="2" data-job-field="task" data-id="${vehicle.id}">${vehicle.jobOrder.task || ''}</textarea></div>
                                            <div class="form-group full-width"><label>Destination Address</label><input type="text" value="${vehicle.jobOrder.destination || ''}" data-job-field="destination" data-id="${vehicle.id}" placeholder="e.g., SM North EDSA"></div>
                                            <div class="form-group full-width" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                                <button class="btn btn-secondary" data-action="set-destination" data-id="${vehicle.id}">Pin Destination</button>
                                                <button class="btn btn-primary" data-action="complete-trip" data-id="${vehicle.id}" ${vehicle.status !== 'On Trip' ? 'disabled' : ''}>Complete Trip</button>
                                            </div>
                                        </div>
                                    </div>
                                </details>
                            </div>
                        `;
                    },
                    
                    showHistoryModal(vehicleId) {
                        const vehicle = this.get('vehicles', vehicleId);
                        let html = `<h2>Trip History for ${vehicle.plate}</h2>`;
                        if (!vehicle.history || vehicle.history.length === 0) {
                            html += '<p>No completed trips recorded.</p>';
                        } else {
                            html += vehicle.history.map(h => `
                                <div class="history-item">
                                    <strong>Ticket:</strong> ${h.ticket} <br>
                                    <strong>Destination:</strong> ${h.destination} <br>
                                    <strong>Driver:</strong> ${h.driverName} <br>
                                    <strong>Completed:</strong> ${new Date(h.completedDate).toLocaleString()}
                                </div>
                            `).join('');
                        }
                        this.ui.modalBody.innerHTML = html;
                        this.ui.modalOverlay.classList.add('show');
                    },

                    showAnalyticsModal() {
                        const html = `
                            <h2>Fleet Analytics</h2>
                            <div class="charts-container">
                                <div>
                                    <h3>Fleet Status</h3>
                                    <canvas id="status-pie-chart"></canvas>
                                </div>
                                <div>
                                    <h3>Trips per Driver</h3>
                                    <canvas id="driver-trips-chart"></canvas>
                                </div>
                            </div>
                        `;
                        this.ui.modalBody.innerHTML = html;
                        this.ui.modalOverlay.classList.add('show');
                        this.view.renderCharts.call(this);
                    },

                    renderCharts() {
                        if (this.charts.statusPie) this.charts.statusPie.destroy();
                        if (this.charts.driverTrips) this.charts.driverTrips.destroy();

                        const statusCounts = this.state.vehicles.reduce((acc, v) => {
                            acc[v.status] = (acc[v.status] || 0) + 1;
                            return acc;
                        }, {});

                        this.charts.statusPie = new Chart(document.getElementById('status-pie-chart'), {
                            type: 'pie',
                            data: {
                                labels: Object.keys(statusCounts),
                                datasets: [{
                                    data: Object.values(statusCounts),
                                    backgroundColor: Object.keys(statusCounts).map(status => `var(--status-${status.toLowerCase().replace(' ', '-')})`)
                                }]
                            },
                             options: { responsive: true }
                        });

                        const driverTripCounts = this.state.vehicles.flatMap(v => v.history || []).reduce((acc, h) => {
                            acc[h.driverName] = (acc[h.driverName] || 0) + 1;
                            return acc;
                        }, {});

                        this.charts.driverTrips = new Chart(document.getElementById('driver-trips-chart'), {
                            type: 'bar',
                            data: {
                                labels: Object.keys(driverTripCounts),
                                datasets: [{
                                    label: 'Completed Trips',
                                    data: Object.values(driverTripCounts),
                                    backgroundColor: '#00796B'
                                }]
                            },
                            options: { indexAxis: 'y', responsive: true }
                        });
                    },

                    showToast(message) {
                        this.ui.toast.textContent = message;
                        this.ui.toast.classList.add('show');
                        setTimeout(() => this.ui.toast.classList.remove('show'), 3000);
                    }
                },
                
                // --- EVENT HANDLER LOGIC ---
                eventHandlers: {
                    handlePanelClick(e) {
                        const target = e.target.closest('[data-action]');
                        if (!target) return;
                        const { action, id } = target.dataset;
                        const parsedId = parseInt(id);

                        switch(action) {
                            case 'add-vehicle':
                                this.add('vehicles', { plate: `NEW-${Date.now() % 10000}`, model: 'New Vehicle', odometer: 0, driverId: null, status: 'Available', nextServiceKm: 10000, jobOrder: { ticket: '', destination: '', task: '', priority: 'Medium' } });
                                break;
                            case 'remove-vehicle':
                                if (confirm('Are you sure you want to remove this vehicle?')) this.remove('vehicles', parsedId);
                                break;
                            case 'add-driver':
                                const name = prompt("Enter new driver's name:");
                                if (name && name.trim()) this.add('drivers', { name: name.trim() });
                                break;
                            case 'remove-driver':
                                if (confirm('Are you sure you want to remove this driver?')) this.remove('drivers', parsedId);
                                break;
                            case 'view-history':
                                this.view.showHistoryModal.call(this, parsedId);
                                break;
                            case 'show-analytics':
                                this.view.showAnalyticsModal.call(this);
                                break;
                             case 'set-destination':
                                this.mapHandlers.setDestinationOnMap.call(this, parsedId, true);
                                break;
                             case 'complete-trip':
                                this.update('vehicles', parsedId, 'status', 'Available');
                                this.mapHandlers.removeMapElements.call(this, parsedId);
                                break;
                        }
                    },
                    handlePanelChange(e) {
                        const { field, jobField, id } = e.target.dataset;
                        if (!id) return;

                        const vehicleId = parseInt(id);
                        const value = e.target.value;

                        if (field) this.update('vehicles', vehicleId, field, value);
                        if (jobField) this.updateJobOrder(vehicleId, jobField, value);
                    }
                },
                
                // --- MAP HANDLER LOGIC ---
                mapHandlers: {
                    async setDestinationOnMap(vehicleId, zoomToView) {
                        const vehicle = this.get('vehicles', vehicleId);
                        if (!vehicle || !vehicle.jobOrder.destination) {
                            this.view.showToast.call(this, 'Please enter a destination first.');
                            return;
                        }

                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(vehicle.jobOrder.destination)}`);
                            if (!response.ok) throw new Error(`Geocoding failed`);
                            const data = await response.json();

                            if (data && data.length > 0) {
                                const { lat, lon } = data[0];
                                const coords = [parseFloat(lat), parseFloat(lon)];
                                this.mapHandlers.updateMarker.call(this, vehicleId, coords);
                                if (zoomToView) this.map.setView(coords, 14);
                                this.view.showToast.call(this, 'Destination pinned on map.');
                            } else {
                                this.view.showToast.call(this, 'Destination not found.');
                            }
                        } catch (error) {
                            console.error('Geocoding error:', error);
                            this.view.showToast.call(this, 'Error contacting map services.');
                        }
                    },
                    updateMarker(vehicleId, newCoords = null) {
                        const vehicle = this.get('vehicles', vehicleId);
                        if (!vehicle) return;

                        const createIcon = (v) => L.divIcon({
                            className: `vehicle-marker marker-status-${v.status.replace(/\s+/g, '-')}`,
                            html: `<div>${v.plate}</div>`,
                            iconSize: [80, 25], iconAnchor: [40, 12]
                        });
                        
                        let marker = this.markers[vehicleId];
                        if (marker) {
                            if (newCoords) marker.setLatLng(newCoords);
                            marker.setIcon(createIcon(vehicle));
                        } else if (newCoords) {
                            marker = L.marker(newCoords, { icon: createIcon(vehicle) }).addTo(this.map);
                            this.markers[vehicleId] = marker;
                        }

                        if (marker) {
                            const driver = this.get('drivers', vehicle.driverId);
                            marker.bindPopup(`<b>Plate:</b> ${vehicle.plate}<br><b>Driver:</b> ${driver ? driver.name : 'N/A'}<br><b>Status:</b> ${vehicle.status}`);
                        }
                    },
                    removeMapElements(vehicleId) {
                        if (this.markers[vehicleId]) {
                            this.map.removeLayer(this.markers[vehicleId]);
                            delete this.markers[vehicleId];
                        }
                    }
                }
            };
            app.init();
        });
    </script>
</body>
</html>

